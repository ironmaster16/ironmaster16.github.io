# Redirect Auto-Fix Tool - How To

Automatically updates redirected URLs in your markdown files based on results from `check_links.py`.

## Quick Start

```bash
# 1. First, check all links
python3 scripts/check_links.py

# 2. Preview what would be fixed (safe, no changes)
python3 scripts/fix_redirects.py

# 3. Apply the fixes
python3 scripts/fix_redirects.py --apply
```

---

## How It Works

1. Reads `scripts/link_check_results.json` (generated by `check_links.py`)
2. Filters redirects based on flags (skips problematic ones by default)
3. Shows preview of what will be changed
4. If `--apply` is used:
   - Creates timestamped backup of `_includes/`
   - Updates URLs in markdown files
   - Reports results

---

## Common Usage Examples

### Preview Mode (Safe Default)

```bash
# See what would be fixed without making changes
python3 scripts/fix_redirects.py
```

**Output:**
```
WILL FIX 5 REDIRECTS:
=====================

[1] transportation.md
    OLD: https://straeto.is/en/
    NEW: https://straeto.is
    TYPE: Path change

[2] practical.md
    OLD: http://bonus.is
    NEW: https://bonus.is
    TYPE: Protocol upgrade (http→https)
```

### Apply Fixes

```bash
# Actually modify the files
python3 scripts/fix_redirects.py --apply
```

**Creates backup automatically:**
```
✓ Backup created: _includes_backup_20251025_143022/
✓ transportation.md - Updated 1 link
✓ practical.md - Updated 1 link
```

### Skip HTTP→HTTPS Changes

```bash
# Only fix path changes, skip protocol upgrades
python3 scripts/fix_redirects.py --apply --skip-protocol-only
```

Use this when you want to keep `http://` links for some reason.

### Include Homepage Redirects

```bash
# Fix even redirects that go to homepage (usually not recommended)
python3 scripts/fix_redirects.py --apply --no-skip-homepage
```

**Warning:** Homepage redirects often mean content was removed. Consider manually reviewing these first.

### Verbose Output

```bash
# Show all redirects including skipped ones
python3 scripts/fix_redirects.py --apply -v
```

Shows detailed reasons why redirects were skipped.

---

## All Arguments

| Argument | Default | Description |
|----------|---------|-------------|
| `--apply` | `False` | Actually modify files (default is dry-run) |
| `--skip-homepage` | `True` | Skip redirects to homepage (usually broken) |
| `--no-skip-homepage` | - | Include homepage redirects |
| `--skip-protocol-only` | `False` | Skip http→https only changes |
| `--no-skip-protocol-only` | - | Include protocol upgrades |
| `--skip-cross-domain` | `True` | Skip redirects to different domain |
| `--no-skip-cross-domain` | - | Include cross-domain redirects |
| `--backup` | `True` | Create backup before modifying |
| `--no-backup` | - | Skip backup (NOT recommended) |
| `--results FILE` | `scripts/link_check_results.json` | Custom results file |
| `--includes-dir DIR` | `_includes/` | Custom includes directory |
| `--min-redirects N` | `1` | Minimum redirects to bother fixing |
| `-v` / `--verbose` | `False` | Show detailed output |

---

## What Gets Fixed vs Skipped

### ✅ Fixed by Default

- **Path changes**: `example.com/old-page` → `example.com/new-page`
- **Protocol upgrades**: `http://example.com` → `https://example.com`
- **Query string changes**: `example.com?old=1` → `example.com?new=1`
- **Trailing slash changes**: `example.com/page` → `example.com/page/`

### ❌ Skipped by Default

- **Homepage redirects**: `example.com/page` → `example.com/`
  - Reason: Content likely removed or moved elsewhere
  - Override: `--no-skip-homepage`

- **Cross-domain redirects**: `old-site.com` → `new-site.com`
  - Reason: Might be intentional (affiliate links, tracking)
  - Override: `--no-skip-cross-domain`

### ⚙️ Optional Skips

- **Protocol-only changes**: `http://` → `https://`
  - Default: Fixed automatically
  - Skip with: `--skip-protocol-only`

---

## Safety Features

### 1. Dry-Run by Default

The script **never** modifies files unless you use `--apply`.

```bash
python3 scripts/fix_redirects.py           # Safe preview
python3 scripts/fix_redirects.py --apply   # Actually changes files
```

### 2. Automatic Backups

Before any changes, creates timestamped backup:

```
_includes_backup_20251025_143022/
├── emergency.md
├── transportation.md
├── practical.md
└── ...
```

**To restore from backup:**
```bash
rm -rf _includes/
mv _includes_backup_20251025_143022/ _includes/
```

**Skip backup** (not recommended):
```bash
python3 scripts/fix_redirects.py --apply --no-backup
```

### 3. Git Integration

After applying fixes, review with git:

```bash
# See what changed
git diff

# Revert if needed
git checkout -- _includes/

# Or restore specific file
git checkout -- _includes/transportation.md
```

---

## Workflow Examples

### Scenario 1: Routine Maintenance

```bash
# Check links weekly
python3 scripts/check_links.py

# If redirects found, preview fixes
python3 scripts/fix_redirects.py

# Apply if they look good
python3 scripts/fix_redirects.py --apply

# Review and commit
git diff
git add _includes/
git commit -m "Update redirected URLs"
```

### Scenario 2: Conservative Approach

```bash
# Only fix safe redirects (skip protocol changes and homepage redirects)
python3 scripts/fix_redirects.py --apply --skip-protocol-only --skip-homepage

# Review changes
git diff

# Commit
git add _includes/
git commit -m "Fix redirected URLs (conservative)"
```

### Scenario 3: Aggressive Fixing

```bash
# Fix everything including cross-domain and homepage redirects
python3 scripts/fix_redirects.py --apply --no-skip-cross-domain --no-skip-homepage

# Carefully review changes
git diff

# Test locally
jekyll serve

# Commit if all looks good
git add _includes/
git commit -m "Fix all redirected URLs"
```

### Scenario 4: Custom Results File

```bash
# Use old results file
python3 scripts/fix_redirects.py --results scripts/old_results.json --apply
```

---

## Troubleshooting

### "Results file not found"

```
❌ Error: Results file not found: scripts/link_check_results.json
   Run check_links.py first to generate results
```

**Solution:** Run link checker first:
```bash
python3 scripts/check_links.py
```

### "No redirects found"

```
✅ No redirects found in results
```

**Possible reasons:**
- All links are working correctly (good!)
- Links haven't been checked yet
- Results file is from old run before redirects existed

### "Only X fixable redirects found"

```
⚠️  Only 0 fixable redirects found
   Minimum required: 1
```

**Reasons:**
- All redirects were filtered out (homepage, cross-domain, etc.)
- Use `-v` to see why redirects were skipped
- Override filters with `--no-skip-*` flags

**Example:**
```bash
python3 scripts/fix_redirects.py -v   # See why redirects were skipped
```

### Changes Not Applied

If files show as updated but URLs didn't change:

1. **Check if URLs are in correct format** - Script looks for `href="URL"` pattern
2. **URLs might already be fixed** - Run `check_links.py` again
3. **Manual review needed** - Some complex cases require manual editing

### Backup Not Found After Fix

Backups are timestamped: `_includes_backup_YYYYMMDD_HHMMSS/`

```bash
# List all backups
ls -la | grep _includes_backup

# Restore most recent
mv _includes_backup_20251025_143022/ _includes/
```

---

## Best Practices

### 1. Always Preview First

```bash
python3 scripts/fix_redirects.py     # Preview
# Review output carefully
python3 scripts/fix_redirects.py --apply   # Then apply
```

### 2. Use Git to Review Changes

```bash
python3 scripts/fix_redirects.py --apply
git diff                              # Review every change
```

### 3. Test Locally Before Pushing

```bash
python3 scripts/fix_redirects.py --apply
git diff
# Test site locally if possible
git add _includes/
git commit -m "Fix redirected URLs"
git push
```

### 4. Keep Backups for a While

Don't delete backup directories immediately:

```bash
# Keep backups for a week or two
ls -la | grep _includes_backup

# Delete old backups manually when confident
rm -rf _includes_backup_20251015_120000/
```

### 5. Start Conservative

If unsure, start with safe defaults:

```bash
# Skip homepage redirects (default)
# Skip cross-domain redirects (default)
# Include protocol upgrades (default)
python3 scripts/fix_redirects.py --apply
```

---

## Integration with Link Checker

### Full Workflow

```bash
# 1. Check all links
python3 scripts/check_links.py --verbose

# 2. Review the report
# (Shows redirects, broken links, slow links)

# 3. Fix redirects automatically
python3 scripts/fix_redirects.py

# 4. If preview looks good, apply
python3 scripts/fix_redirects.py --apply

# 5. Fix broken links manually
# (Review JSON results for 404s)

# 6. Commit changes
git add _includes/
git commit -m "Fix redirects and update links"
```

### Automation (Cron Job)

**Not recommended** - Manual review is safer. But if you want to automate:

```bash
# Weekly link check + auto-fix (conservative)
0 3 * * 0 cd ~/ironmaster16.github.io && python3 scripts/check_links.py && python3 scripts/fix_redirects.py --apply --skip-homepage --min-redirects 3
```

**Better approach:** Automate checking, manually review and fix:

```bash
# Cron: Weekly check only
0 3 * * 0 cd ~/ironmaster16.github.io && python3 scripts/check_links.py

# Manual: Review and fix when you see redirects
python3 scripts/fix_redirects.py --apply
```

---

## Examples by Redirect Type

### HTTP → HTTPS (Protocol Upgrade)

```
OLD: http://bonus.is
NEW: https://bonus.is
```

**Default:** Fixed automatically
**Skip:** `--skip-protocol-only`
**Recommendation:** Always fix these (security upgrade)

### Path Change

```
OLD: https://straeto.is/en/routes
NEW: https://straeto.is/routes
```

**Default:** Fixed automatically
**Recommendation:** Always fix these (proper redirect)

### Homepage Redirect

```
OLD: https://booking.com/iceland-hotels
NEW: https://booking.com/
```

**Default:** Skipped
**Include:** `--no-skip-homepage`
**Recommendation:** Skip (content likely removed, needs manual review)

### Cross-Domain

```
OLD: https://old-tourism-site.is
NEW: https://visiticeland.com
```

**Default:** Skipped
**Include:** `--no-skip-cross-domain`
**Recommendation:** Skip (might be intentional affiliate/partnership)

---

## Quick Reference

```bash
# Most common usage
python3 scripts/fix_redirects.py              # Preview
python3 scripts/fix_redirects.py --apply      # Fix

# Conservative (recommended for first time)
python3 scripts/fix_redirects.py --apply --skip-protocol-only

# See what was skipped
python3 scripts/fix_redirects.py -v

# Aggressive (fix everything)
python3 scripts/fix_redirects.py --apply --no-skip-homepage --no-skip-cross-domain

# Restore from backup
mv _includes_backup_YYYYMMDD_HHMMSS/ _includes/

# Review with git
git diff _includes/
```

---

## Support

For issues or questions:
1. Check `scripts/link_check_results.json` for raw redirect data
2. Run with `-v` to see why redirects were skipped
3. Test fixes with `--apply` on a git branch first
4. Review the link checker logs: `scripts/link_checker.log`
